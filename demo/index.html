<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unglish Word Generator Demo</title>
    <style>
        :root {
            --bg: white;
            --fg: black;
            --muted: gray;
            --card-border: silver;
            --card-bg: whitesmoke;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: black;
                --fg: white;
                --muted: darkgray;
                --card-border: dimgray;
                --card-bg: #111;
            }
        }

        body {
            font-family: ui-serif, Georgia, serif;
            background: var(--bg);
            color: var(--fg);
            max-width: 42em;
            margin: 0 auto;
            padding: 2em 1em;
        }

        header { text-align: center; }
        header p { color: var(--muted); font-style: italic; }

        /* Tabs — plain unstyled buttons */
        .tab-bar { display: flex; gap: 0.5em; margin-bottom: 1em; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 1em 1.25em;
            margin: 1em 0;
            background: var(--card-bg);
            position: relative;
        }
        .card h2 {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
        }

        /* Refresh buttons — using U+21BB clockwise open circle arrow */
        .refresh {
            position: absolute;
            top: 0.75em;
            right: 0.75em;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: var(--muted);
            line-height: 1;
        }
        .refresh:hover { color: var(--fg); }
        .page-btn { padding: 0.2em 0.6em; border: 1px solid var(--muted); background: var(--bg); color: var(--fg); cursor: pointer; font-size: 0.85em; }
        .page-btn:hover:not(:disabled) { background: var(--muted); color: var(--bg); }
        .page-btn:disabled { opacity: 0.4; cursor: default; }

        /* Single word */
        .single-written { font-size: 2em; font-weight: 700; }
        .pronunciation { font-family: monospace; color: var(--muted); }

        /* Haiku */
        .haiku-written { font-size: 1.2em; }
        .haiku-ipa { font-family: monospace; color: var(--muted); font-size: 0.85em; }

        /* Slogan */
        .slogan-text { font-size: 1.3em; font-weight: 600; text-transform: capitalize; }

        /* Stat line */
        .stat-line { font-style: italic; color: var(--muted); font-size: 0.85em; }

        /* Lexicon placeholder */
        .placeholder { color: var(--muted); font-style: italic; padding: 3em 0; text-align: center; }

        /* Word wall */
        .word-wall { line-height: 2.2; }
        .word-pill {
            display: inline-block;
            padding: 0.15em 0.5em;
            margin: 0.1em 0.15em;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .syl-1 { background: gainsboro; color: black; }
        .syl-2 { background: darkgray; color: black; }
        .syl-3 { background: gray; color: white; }
        .syl-4 { background: dimgray; color: white; }
        .legend { font-size: 0.8em; color: var(--muted); margin-top: 0.5em; }
        .legend span { margin-right: 1em; }

        /* Horizontal bar charts */
        .bar-chart { margin: 0.5em 0; }
        .bar-row { display: flex; align-items: center; margin: 0.2em 0; font-size: 0.85em; }
        .bar-label { width: 3.5em; text-align: right; padding-right: 0.5em; flex-shrink: 0; }
        .bar-track { flex: 1; background: var(--card-bg); height: 1.2em; position: relative; border: 1px solid var(--card-border); }
        .bar-fill { height: 100%; display: inline-block; vertical-align: top; }
        .bar-value { font-size: 0.8em; color: var(--muted); padding-left: 0.4em; white-space: nowrap; flex-shrink: 0; }

        /* Frequency comparison */
        .freq-row { display: flex; align-items: center; margin: 0.15em 0; font-size: 0.8em; }
        .freq-letter { width: 1.5em; text-align: right; padding-right: 0.4em; font-weight: bold; flex-shrink: 0; }
        .freq-bars { flex: 1; }
        .freq-bar { height: 0.6em; display: block; margin: 1px 0; }
        .freq-unglish { background: dimgray; }
        .freq-english { background: silver; }
        .freq-val { font-size: 0.75em; color: var(--muted); padding-left: 0.3em; flex-shrink: 0; width: 6em; }


        /* Common words race */
        .cw-pill {
            display: inline-block;
            padding: 0.15em 0.5em;
            margin: 0.1em;
            border-radius: 3px;
            font-size: 0.85em;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--muted);
            transition: all 0.3s;
        }
        .cw-pill.found { background: dimgray; color: white; border-color: dimgray; }
        .cw-status { font-size: 0.85em; color: var(--muted); margin-top: 0.5em; }

        /* Pick the Real Word game */
        .real-btn {
            display: inline-block;
            width: 48%;
            text-align: center;
            font: inherit;
            font-size: 1.1em;
            padding: 0.6em 0.75em;
            margin: 0.3em 1%;
            cursor: pointer;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--fg);
            border-radius: 3px;
        }
        .real-btn:hover { border-color: var(--fg); }
        .real-btn.correct { background: darkgray; color: white; border-color: darkgray; }
        .real-btn.wrong { background: var(--card-bg); border-color: var(--fg); text-decoration: line-through; }
        .real-btn.revealed { cursor: default; }
        .real-btn.correct.revealed { opacity: 1; }
        .real-btn.wrong.revealed { opacity: 0.5; }
        .game-score { font-weight: bold; margin-bottom: 0.5em; }
        .game-actions { margin-top: 0.75em; }
        .game-actions button {
            font: inherit;
            padding: 0.4em 1em;
            cursor: pointer;
            background: dimgray;
            color: white;
            border: none;
            border-radius: 3px;
            margin-right: 0.5em;
        }
        .game-actions button:hover { background: gray; }
        .start-btn {
            font: inherit;
            padding: 0.4em 1em;
            cursor: pointer;
            background: dimgray;
            color: white;
            border: none;
            border-radius: 3px;
        }
        .start-btn:hover { background: gray; }
        .ref-line { font-size: 0.8em; color: var(--muted); font-style: italic; margin-top: 0.3em; }

        .sort-btn { padding: 0.2em 0.7em; border: 1px solid var(--muted); background: var(--bg); color: var(--fg); cursor: pointer; font-size: 0.9em; border-radius: 3px; }
        .sort-btn:hover:not(.active) { background: var(--muted); color: var(--bg); }
        .sort-btn.active { background: var(--fg); color: var(--bg); }
    </style>
    <script src="cmuBaselines.js"></script>
    <script type="module">
        import unglish, { generateWords } from '../dist/index.js';
        import { realWords } from './realwords.js';

        const BUILD_INFO = '__BUILD_INFO__'; // Replaced during build

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            const $ = id => document.getElementById(id);
            
            // Display build info
            $('build-info').textContent = BUILD_INFO;

            const morphToggle = $('morph-toggle');
            const useMorph = () => morphToggle.checked;

            let currentWord = '';
            function genSingleWord() {
                const w = unglish.generateWord({ mode: 'text', morphology: useMorph() });
                currentWord = w.written.clean;
                $('single-written').textContent = currentWord;
                $('single-ipa').textContent = w.pronunciation;
            }

            function speakWord() {
                if (!currentWord || !window.speechSynthesis) return;
                const utt = new SpeechSynthesisUtterance(currentWord);
                utt.lang = 'en-GB';
                utt.rate = 0.85;
                speechSynthesis.speak(utt);
            }

            function genHaiku() {
                const patterns = [[2,2,1],[3,2,2],[2,1,2]];
                const lines = patterns.map(p => p.map(n => unglish.generateWord({ syllableCount: n, mode: 'text', morphology: useMorph() })));
                $('haiku-written').innerHTML = lines.map(l => l.map(w => w.written.clean).join(' ')).join('<br>');
                $('haiku-ipa').innerHTML = lines.map(l => l.map(w => w.pronunciation).join(' ')).join('<br>');
            }

            const firstWords = [
                "Ignore Haters \u2014", "Always", "Just", "Never", "Forever", "Never Quit \u2014",
                "Passionately", "Fearlessly", "Endlessly", "Forget Fear \u2014",
                "You Can", "Relentlessly",
            ];
            const lastWords = [
                "It", "Your Dreams", "Success", "Your Enemies", "Fear", "Love", "Tomorrow",
                "Yourself", "The Future", "Greatness", "Excellence", "Possibilities",
                "Potential", "Destiny", "The World", "Your Goals", "Perfection",
                "Innovation", "Happiness", "Victory", "Hard Things"
            ];
            const pick = arr => arr[Math.floor(Math.random() * arr.length)];
            const randInt = (a, b) => a + Math.floor(Math.random() * (b - a + 1));

            function genSlogan() {
                const w = unglish.generateWord({ syllableCount: 1, mode: 'text', morphology: useMorph() });
                $('slogan-text').textContent = `${pick(firstWords)} ${w.written.clean} ${pick(lastWords)}`;
            }

            // Sentence templates — slots: W=any word, N=noun-like(2-3syl), V=verb-like(1syl), A=adj-like(2syl)
            const templates = [
                'The W of W',
                'W and W W the W',
                'A W W the W',
                'The W W, but the W W',
                'W W the W of W',
                'It W the W',
                'W W, W W',
                'The W W W',
                'W the W and W',
                'No W W without W',
                'Every W W a W',
                'W W; the W W',
                'Some W W the W of W',
                'W W the W, then W',
                'A W of W and W',
                'Was it W or W?',
                'The W W W the W',
            ];

            function genFromTemplate() {
                const tmpl = pick(templates);
                const allWords = [];
                const text = tmpl.replace(/W/g, () => {
                    const w = unglish.generateWord({ mode: 'text', morphology: useMorph() });
                    allWords.push(w);
                    return w.written.clean;
                });
                // Capitalize first letter
                const capped = text.charAt(0).toUpperCase() + text.slice(1);
                // Add terminal punctuation (already has ? if template includes it)
                const final = capped.endsWith('?') ? capped : capped + '.';
                return { text: final, words: allWords };
            }

            function makeSentence() {
                return genFromTemplate();
            }

            function genSentence() {
                const s = makeSentence();
                $('sentence-text').textContent = s.text;
            }

            function genParagraph() {
                const allWords = [];
                const paragraphs = [];
                for (let p = 0; p < 2; p++) {
                    const sentences = [];
                    const count = randInt(3, 5);
                    for (let i = 0; i < count; i++) {
                        const s = makeSentence();
                        sentences.push(s.text);
                        allWords.push(...s.words);
                    }
                    paragraphs.push(sentences.join(' '));
                }
                $('paragraph-text').innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');

                const mono = allWords.filter(w => w.syllables.length === 1).length;
                const monoPct = ((mono / allWords.length) * 100).toFixed(1);
                const avgLen = (allWords.reduce((s, w) => s + w.written.clean.length, 0) / allWords.length).toFixed(1);
                $('paragraph-stats').textContent = `${allWords.length} words \u00b7 ${monoPct}% monosyllabic \u00b7 avg ${avgLen} letters`;
            }

            // --- Tab switching ---
            document.querySelectorAll('.tab-bar button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-bar button').forEach(b => b.disabled = false);
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.disabled = true;
                    $(btn.dataset.tab).classList.add('active');
                });
            });

            $('refresh-single').addEventListener('click', genSingleWord);
            $('speak-single').addEventListener('click', speakWord);
            $('refresh-haiku').addEventListener('click', genHaiku);
            $('refresh-slogan').addEventListener('click', genSlogan);
            $('refresh-sentence').addEventListener('click', genSentence);
            $('refresh-paragraph').addEventListener('click', genParagraph);

            // ===== LEXICON TAB =====

            const sylColors = ['syl-1','syl-2','syl-3','syl-4'];
            const sylLabels = ['1 syl','2 syl','3 syl','4+ syl'];
            const sylBgNames = ['gainsboro','darkgray','gray','dimgray'];

            let lexWords = [];

            function genWordWall() {
                lexWords = generateWords(200, { mode: 'lexicon', morphology: useMorph() });
                const wall = $('word-wall');
                wall.innerHTML = '';
                lexWords.forEach(w => {
                    const sp = document.createElement('span');
                    const sc = Math.min(w.syllables.length, 4);
                    sp.className = 'word-pill ' + sylColors[sc - 1];
                    sp.textContent = w.written.clean;
                    sp.title = w.pronunciation + ' (' + sc + ' syl)';
                    wall.appendChild(sp);
                });
                // legend
                $('wall-legend').innerHTML = sylLabels.map((l,i) =>
                    '<span><span class="word-pill ' + sylColors[i] + '">' + l + '</span></span>'
                ).join('');
            }

                        // Common words race
            let cwWorker = null;
            $('cw-start').addEventListener('click', function() {
                this.disabled = true;
                $('cw-pills').innerHTML = '';
                $('cw-status').textContent = 'Starting...';
                if (cwWorker) cwWorker.terminate();
                cwWorker = new Worker('commonWordsWorker.js');
                cwWorker.onmessage = function(e) {
                    if (e.data.type === 'wordList') {
                        $('cw-pills').innerHTML = e.data.words.map(w => '<span class="cw-pill" id="cw-' + w + '">' + w + '</span>').join('');
                    } else if (e.data.type === 'wordFound') {
                        const pill = document.getElementById('cw-' + e.data.word);
                        if (pill) pill.classList.add('found');
                        $('cw-status').textContent = (100 - e.data.remainingCount) + '/100 found · ' + e.data.iterations.toLocaleString() + ' generated · ' + e.data.time + 's';
                    } else if (e.data.type === 'progress') {
                        $('cw-status').textContent = e.data.foundCount + '/100 found · ' + e.data.iterations.toLocaleString() + ' generated...';
                    } else if (e.data.type === 'complete') {
                        const unique = e.data.uniqueCount || e.data.iterations;
                        const uniquePct = ((unique / e.data.iterations) * 100).toFixed(1);
                        $('cw-status').textContent = 'All 100 found in ' + e.data.iterations.toLocaleString() + ' generations (' + e.data.duration + 's) \u00b7 ' + unique.toLocaleString() + ' unique (' + uniquePct + '%)';
                        $('cw-start').disabled = false;
                        cwWorker.terminate();
                        cwWorker = null;
                    }
                };
                cwWorker.postMessage({ action: 'findCommonWords' });
            });

            // "Pick the Real Word" game — 2 choices, one real, one generated
            let gameRound = 0, gameCorrect = 0, gamePlayed = 0;
            const usedRealWords = new Set();

            function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

            function pickUnusedReal() {
                let word;
                do { word = realWords[Math.floor(Math.random() * realWords.length)]; } while (usedRealWords.has(word));
                usedRealWords.add(word);
                return word;
            }

            function newGameRound() {
                gameRound = 0; gameCorrect = 0; gamePlayed = 0;
                $('game-score').textContent = '';
                $('game-actions').innerHTML = '';
                showNextPair();
            }

            function showNextPair() {
                const real = pickUnusedReal();
                const fake = unglish.generateWord({ mode: 'lexicon', morphology: useMorph() }).written.clean;
                const pair = shuffle([{word: real, real: true}, {word: fake, real: false}]);
                gameRound++;

                $('game-words').innerHTML = '<p style="color:var(--muted);font-size:0.85em">Round ' + gameRound + ' \u2014 Pick the real English word:</p>' +
                    pair.map((p, i) =>
                        '<button class="real-btn" data-idx="' + i + '">' + p.word + '</button>'
                    ).join(' ');

                document.querySelectorAll('.real-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.classList.contains('revealed')) return;
                        const idx = parseInt(this.dataset.idx);
                        const picked = pair[idx];
                        const other = pair[1 - idx];
                        gamePlayed++;
                        if (picked.real) gameCorrect++;

                        // Reveal both
                        document.querySelectorAll('.real-btn').forEach((b, bi) => {
                            b.classList.add('revealed');
                            const p = pair[bi];
                            b.classList.add(p.real ? 'correct' : 'wrong');
                            b.innerHTML = p.word + ' <span style="font-size:0.75em;opacity:0.7">' + (p.real ? '\u2713 real' : '\u2717 fake') + '</span>';
                        });

                        $('game-score').textContent = gameCorrect + '/' + gamePlayed + ' correct';

                        if (gamePlayed >= 10) {
                            const pct = (gameCorrect / 10 * 100);
                            const verdict = pct >= 90 ? 'Suspicious. Are you a dictionary?' :
                                            pct >= 70 ? 'Sharp eye.' :
                                            pct >= 50 ? 'Not bad \u2014 the generator fooled you a few times.' :
                                            'The generator wins this round.';
                            $('game-actions').innerHTML = '<p style="margin:0.5em 0"><strong>' + gameCorrect + '/10</strong> \u2014 ' + verdict + '</p>' +
                                '<button class="start-btn" id="game-new">Play Again</button>';
                            $('game-new').addEventListener('click', newGameRound);
                        } else {
                            $('game-actions').innerHTML = '<button class="start-btn" id="game-next">Next \u2192</button>';
                            $('game-next').addEventListener('click', showNextPair);
                        }
                    });
                });
            }

            $('refresh-wall').addEventListener('click', () => { genWordWall(); });

            // Init lexicon on first tab switch (lazy) or immediately if active
            let lexiconInited = false;
            function initLexicon() {
                if (lexiconInited) return;
                lexiconInited = true;
                genWordWall();
                newGameRound();
            }

            // ===== STATS TAB =====

            // CMU Pronouncing Dictionary baselines (unique words, lexicon mode)
            const engLetterFreq = {e:11.46,a:8.80,r:7.76,i:7.65,n:7.28,s:6.92,o:6.42,t:5.85,l:5.83,c:3.91,d:3.52,m:3.11,u:3.07,h:2.88,g:2.77,p:2.29,b:2.25,k:1.80,y:1.60,f:1.39,w:1.10,v:1.05,z:0.65,j:0.26,x:0.23,q:0.14};
            const engLengthDist = {1:0,2:0.2,3:1.3,4:5.2,5:11.5,6:17.4,7:18.6,8:15.5,9:11.7,10:8.1,11:4.8,12:2.7,13:2.4};

            function pearsonR(xs, ys) {
                const n = xs.length;
                const mx = xs.reduce((a,b) => a+b, 0) / n;
                const my = ys.reduce((a,b) => a+b, 0) / n;
                let num = 0, dx2 = 0, dy2 = 0;
                for (let i = 0; i < n; i++) {
                    const dx = xs[i] - mx, dy = ys[i] - my;
                    num += dx * dy; dx2 += dx * dx; dy2 += dy * dy;
                }
                return num / Math.sqrt(dx2 * dy2);
            }

            let statsWorker = null;
            let statsInited = false;
            let chartData = null;

            function sortItems(items, mode) {
                const sorted = [...items];
                if (mode === 'divergence') {
                    sorted.sort((a, b) => {
                        const da = a.eng !== null ? Math.abs(a.gen - a.eng) : -1;
                        const db = b.eng !== null ? Math.abs(b.gen - b.eng) : -1;
                        return db - da;
                    });
                } else if (mode === 'english') {
                    sorted.sort((a, b) => (b.eng ?? -Infinity) - (a.eng ?? -Infinity));
                } else { // unglish
                    sorted.sort((a, b) => b.gen - a.gen);
                }
                return sorted;
            }

            function rerenderCharts(mode) {
                if (!chartData) return;
                renderPaginatedChart('stats-letter-chart', 'stats-letter-pager', sortItems(chartData.letterItems, mode), 15, '1.5em', 1);
                renderPaginatedChart('stats-bigram-chart', 'stats-bigram-pager', sortItems(chartData.bigramItems, mode), 5, '2.5em', 2);
                renderPaginatedChart('stats-trigram-chart', 'stats-trigram-pager', sortItems(chartData.trigramItems, mode), 2, '2.5em', 2);
                if (chartData.phonemeItems.length > 0) {
                    renderPaginatedChart('stats-phoneme-chart', 'stats-phoneme-pager', sortItems(chartData.phonemeItems, mode), 10, '2.5em', 2);
                }
            }

            function runStats() {
                $('stats-status').textContent = 'Generating 10,000 words...';
                if (statsWorker) statsWorker.terminate();
                statsWorker = new Worker('statsWorker.js?v=' + Date.now());
                statsWorker.onmessage = function(ev) {
                    if (ev.data.type === 'stats') {
                        renderStats(ev.data.words, ev.data.phonemes);
                        statsWorker.terminate();
                        statsWorker = null;
                    }
                };
                statsWorker.postMessage({ action: 'generateStats', count: 10000 });
            }

            // Paginated chart helper
            const PAGE_SIZE = 50;
            const legendHtml = '<span style="display:inline-block;width:0.8em;height:0.8em;background:steelblue;vertical-align:middle"></span> Generated &nbsp; <span style="display:inline-block;width:0.8em;height:0.8em;background:darkgrey;vertical-align:middle"></span> CMU Dictionary';

            function renderPaginatedChart(chartId, pagerId, items, maxPct, labelWidth, decimals) {
                // items: [{key, gen, eng}] sorted by gen desc
                let page = 0;
                const totalPages = Math.ceil(items.length / PAGE_SIZE);

                function renderPage() {
                    const start = page * PAGE_SIZE;
                    const slice = items.slice(start, start + PAGE_SIZE);
                    $(chartId).innerHTML = slice.map(item => {
                        const wG = (item.gen / maxPct * 100).toFixed(1);
                        const wE = item.eng !== null ? (item.eng / maxPct * 100).toFixed(1) : '0';
                        const engStr = item.eng !== null ? item.eng.toFixed(decimals) : '—';
                        return '<div class="freq-row"><div class="freq-letter" style="width:' + labelWidth + '">' + item.label + '</div><div class="freq-bars">' +
                            '<div class="freq-bar" style="width:' + wG + '%;background:steelblue"></div>' +
                            (item.eng !== null ? '<div class="freq-bar" style="width:' + wE + '%;background:darkgrey"></div>' : '') +
                            '</div><div class="freq-val">' + item.gen.toFixed(decimals) + ' / ' + engStr + '</div></div>';
                    }).join('');

                    if (totalPages > 1) {
                        $(pagerId).innerHTML = '<div style="display:flex;align-items:center;gap:0.5em;margin:0.5em 0;font-size:0.85em">' +
                            '<button ' + (page === 0 ? 'disabled' : '') + ' class="page-btn" data-dir="-1">← Prev</button>' +
                            '<span>Page ' + (page + 1) + ' of ' + totalPages + ' (' + items.length + ' total)</span>' +
                            '<button ' + (page >= totalPages - 1 ? 'disabled' : '') + ' class="page-btn" data-dir="1">Next →</button></div>';
                        $(pagerId).querySelectorAll('.page-btn').forEach(btn => {
                            btn.addEventListener('click', () => { page += parseInt(btn.dataset.dir); renderPage(); });
                        });
                    } else {
                        $(pagerId).innerHTML = '<div style="font-size:0.85em;color:var(--muted);margin:0.3em 0">' + items.length + ' entries</div>';
                    }
                }
                renderPage();
            }

            function renderStats(words, phonemeData) {
                $('stats-status').textContent = words.length.toLocaleString() + ' words generated.';

                // Letter frequency (always 26)
                const letterCounts = {};
                let totalLetters = 0;
                for (const w of words) {
                    for (const ch of w.toLowerCase()) {
                        if (ch >= 'a' && ch <= 'z') { letterCounts[ch] = (letterCounts[ch] || 0) + 1; totalLetters++; }
                    }
                }
                const letterItems = Object.keys(engLetterFreq)
                    .map(ch => ({ key: ch, label: ch.toUpperCase(), gen: totalLetters ? (letterCounts[ch] || 0) / totalLetters * 100 : 0, eng: engLetterFreq[ch] }))
                    .sort((a, b) => b.gen - a.gen);
                const letterGenPcts = letterItems.map(x => x.gen);
                const letterEngPcts = letterItems.map(x => x.eng);
                $('stats-letter-r').textContent = 'Pearson r = ' + pearsonR(letterGenPcts, letterEngPcts).toFixed(4);
                $('stats-letter-legend').innerHTML = legendHtml;

                // Bigram frequency — all generated bigrams
                const bigramCounts = {};
                let totalBigrams = 0;
                for (const w of words) {
                    const lw = w.toLowerCase();
                    for (let i = 0; i < lw.length - 1; i++) {
                        const bg = lw[i] + lw[i+1];
                        if (bg[0] >= 'a' && bg[0] <= 'z' && bg[1] >= 'a' && bg[1] <= 'z') {
                            bigramCounts[bg] = (bigramCounts[bg] || 0) + 1; totalBigrams++;
                        }
                    }
                }
                const bigramItems = Object.entries(bigramCounts)
                    .map(([bg, c]) => ({ key: bg, label: bg.toUpperCase(), gen: c / totalBigrams * 100, eng: cmuBigrams[bg] ?? null }))
                    .sort((a, b) => b.gen - a.gen);
                // Pearson r on shared keys only
                const sharedBi = bigramItems.filter(x => x.eng !== null);
                if (sharedBi.length > 1) $('stats-bigram-r').textContent = 'Pearson r = ' + pearsonR(sharedBi.map(x => x.gen), sharedBi.map(x => x.eng)).toFixed(4) + ' (on ' + sharedBi.length + ' shared)';
                $('stats-bigram-legend').innerHTML = legendHtml;

                // Trigram frequency — all generated trigrams
                const trigramCounts = {};
                let totalTrigrams = 0;
                for (const w of words) {
                    const lw = w.toLowerCase();
                    for (let i = 0; i < lw.length - 2; i++) {
                        const tg = lw[i] + lw[i+1] + lw[i+2];
                        if (tg[0] >= 'a' && tg[0] <= 'z' && tg[1] >= 'a' && tg[1] <= 'z' && tg[2] >= 'a' && tg[2] <= 'z') {
                            trigramCounts[tg] = (trigramCounts[tg] || 0) + 1; totalTrigrams++;
                        }
                    }
                }
                const trigramItems = Object.entries(trigramCounts)
                    .map(([tg, c]) => ({ key: tg, label: tg.toUpperCase(), gen: c / totalTrigrams * 100, eng: cmuTrigrams[tg] ?? null }))
                    .sort((a, b) => b.gen - a.gen);
                const sharedTri = trigramItems.filter(x => x.eng !== null);
                if (sharedTri.length > 1) $('stats-trigram-r').textContent = 'Pearson r = ' + pearsonR(sharedTri.map(x => x.gen), sharedTri.map(x => x.eng)).toFixed(4) + ' (on ' + sharedTri.length + ' shared)';
                $('stats-trigram-legend').innerHTML = legendHtml;

                // Phoneme frequency — all generated phonemes
                let phonemeItems = [];
                if (phonemeData) {
                    const phCounts = {};
                    let totalPh = 0;
                    for (const sounds of phonemeData) {
                        for (const s of sounds) { phCounts[s] = (phCounts[s] || 0) + 1; totalPh++; }
                    }
                    phonemeItems = Object.entries(phCounts)
                        .map(([ph, c]) => ({ key: ph, label: ph, gen: c / totalPh * 100, eng: cmuPhonemes[ph] ?? null }))
                        .sort((a, b) => b.gen - a.gen);
                    const sharedPh = phonemeItems.filter(x => x.eng !== null);
                    if (sharedPh.length > 1) $('stats-phoneme-r').textContent = 'Pearson r = ' + pearsonR(sharedPh.map(x => x.gen), sharedPh.map(x => x.eng)).toFixed(4) + ' (on ' + sharedPh.length + ' shared)';
                    $('stats-phoneme-legend').innerHTML = legendHtml;
                }

                chartData = { letterItems, bigramItems, trigramItems, phonemeItems };
                rerenderCharts(currentSort);

                // Word length distribution
                const lenCounts = {};
                for (const w of words) { const len = Math.min(w.length, 13); lenCounts[len] = (lenCounts[len] || 0) + 1; }
                const totalWords = words.length;
                const maxLenPct = 30;
                $('stats-length-legend').innerHTML = legendHtml;
                let lenHtml = '';
                for (let i = 1; i <= 13; i++) {
                    const genPct = (lenCounts[i] || 0) / totalWords * 100;
                    const engPct = engLengthDist[i] || 0;
                    const label = i === 13 ? '13+' : String(i);
                    const wG = (genPct / maxLenPct * 100).toFixed(1);
                    const wE = (engPct / maxLenPct * 100).toFixed(1);
                    lenHtml += '<div class="freq-row"><div class="freq-letter" style="width:2.5em">' + label + '</div><div class="freq-bars">' +
                        '<div class="freq-bar" style="width:' + wG + '%;background:steelblue"></div>' +
                        '<div class="freq-bar" style="width:' + wE + '%;background:darkgrey"></div>' +
                        '</div><div class="freq-val">' + genPct.toFixed(1) + ' / ' + engPct.toFixed(1) + '</div></div>';
                }
                $('stats-length-chart').innerHTML = lenHtml;
            }

            function initStats() {
                if (statsInited) return;
                statsInited = true;
                runStats();
            }

            $('refresh-stats').addEventListener('click', runStats);

            let currentSort = 'divergence';
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentSort = btn.dataset.sort;
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b === btn));
                    rerenderCharts(currentSort);
                });
            });

            // Hook into tab switching
            document.querySelectorAll('.tab-bar button').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.tab === 'content-lexicon') initLexicon();
                    if (btn.dataset.tab === 'content-stats') initStats();
                });
            });

            requestAnimationFrame(() => {
                genSingleWord();
                genHaiku();
                genSlogan();
                genSentence();
                genParagraph();
            });
        }
    </script>
</head>
<body>
    <header>
        <h1>Unglish Word Generator</h1>
        <p>English-sounding nonsense, generated by rule</p>
        <p style="font-size: 0.75em; color: var(--muted);" id="build-info">Loading...</p>
    </header>

    <div class="tabs">
        <div class="tab-bar">
            <button disabled data-tab="content-text">Text</button>
            <button data-tab="content-lexicon">Lexicon</button>
            <button data-tab="content-stats">Stats</button>
            <label style="margin-left:auto;display:flex;align-items:center;gap:0.3em;font-size:0.9em;cursor:pointer">
                <input type="checkbox" id="morph-toggle"> Include affixes
            </label>
        </div>

        <div id="content-text" class="tab-content active">
            <div class="card">
                <h2>Single Word</h2>
                <button class="refresh" id="refresh-single" title="Regenerate">&#x21bb;</button>
                <div class="single-written" id="single-written"></div>
                <div class="pronunciation" id="single-ipa"></div>
                <button class="refresh" id="speak-single" title="Pronounce it" style="right:3em">&#x25B6;</button>
            </div>

            <div class="card">
                <h2>Haiku</h2>
                <button class="refresh" id="refresh-haiku" title="Regenerate">&#x21bb;</button>
                <div class="haiku-written" id="haiku-written"></div>
                <div class="haiku-ipa" id="haiku-ipa"></div>
            </div>

            <div class="card">
                <h2>Slogan</h2>
                <button class="refresh" id="refresh-slogan" title="Regenerate">&#x21bb;</button>
                <div class="slogan-text" id="slogan-text"></div>
            </div>

            <div class="card">
                <h2>Sentence</h2>
                <button class="refresh" id="refresh-sentence" title="Regenerate">&#x21bb;</button>
                <div class="sentence-text" id="sentence-text"></div>
            </div>

            <div class="card">
                <h2>Paragraph</h2>
                <button class="refresh" id="refresh-paragraph" title="Regenerate">&#x21bb;</button>
                <div class="paragraph-text" id="paragraph-text"></div>
                <div class="stat-line" id="paragraph-stats"></div>
            </div>
        </div>

        <div id="content-lexicon" class="tab-content">
            <!-- Word Wall -->
            <div class="card">
                <h2>Word Wall</h2>
                <button class="refresh" id="refresh-wall" title="Regenerate">&#x21bb;</button>
                <div class="word-wall" id="word-wall"></div>
                <div class="legend" id="wall-legend"></div>
            </div>

            <!-- Common Words Race -->
            <div class="card">
                <h2>Common Words Race</h2>
                <p style="font-size:0.85em;color:var(--muted)">How many random words until all 100 most common English words appear?</p>
                <button class="start-btn" id="cw-start">Start Race</button>
                <div id="cw-pills" style="margin-top:0.5em"></div>
                <div class="cw-status" id="cw-status"></div>
            </div>

            <!-- Pick the Real Word -->
            <div class="card">
                <h2>Pick the Real Word</h2>
                <p style="font-size:0.85em;color:var(--muted)">One is real English, one is Unglish. 10 rounds.</p>
                <div class="game-score" id="game-score"></div>
                <div id="game-words"></div>
                <div class="game-actions" id="game-actions"></div>
            </div>
        </div>
        <div id="content-stats" class="tab-content">
            <div style="display:flex;align-items:center;gap:0.5em;margin:0 0 1em 0;font-size:0.9em">
                <span style="color:var(--muted)">Sort:</span>
                <button class="sort-btn active" data-sort="divergence">Deviation</button>
                <button class="sort-btn" data-sort="english">English freq</button>
                <button class="sort-btn" data-sort="unglish">Unglish freq</button>
            </div>
            <div class="card">
                <h2>Letter Frequency — Generated vs CMU Dictionary</h2>
                <button class="refresh" id="refresh-stats" title="Regenerate">&#x21bb;</button>
                <div id="stats-status" class="stat-line">Click Regenerate or switch to this tab to generate 10,000 words.</div>
                <div id="stats-letter-r" style="font-size:1.1em;font-weight:bold;margin:0.5em 0"></div>
                <div class="legend" id="stats-letter-legend"></div>
                <div id="stats-letter-chart"></div>
                <div id="stats-letter-pager"></div>
            </div>

            <div class="card">
                <h2>Bigram Frequency — Generated vs CMU Dictionary</h2>
                <div id="stats-bigram-r" style="font-size:1.1em;font-weight:bold;margin:0.5em 0"></div>
                <div class="legend" id="stats-bigram-legend"></div>
                <div id="stats-bigram-chart"></div>
                <div id="stats-bigram-pager"></div>
            </div>

            <div class="card">
                <h2>Trigram Frequency — Generated vs CMU Dictionary</h2>
                <div id="stats-trigram-r" style="font-size:1.1em;font-weight:bold;margin:0.5em 0"></div>
                <div class="legend" id="stats-trigram-legend"></div>
                <div id="stats-trigram-chart"></div>
                <div id="stats-trigram-pager"></div>
            </div>

            <div class="card">
                <h2>Phoneme Frequency — Generated vs CMU Dictionary</h2>
                <div id="stats-phoneme-r" style="font-size:1.1em;font-weight:bold;margin:0.5em 0"></div>
                <div class="legend" id="stats-phoneme-legend"></div>
                <div id="stats-phoneme-chart"></div>
                <div id="stats-phoneme-pager"></div>
            </div>

            <div class="card">
                <h2>Word Length Distribution — Generated vs CMU Dictionary</h2>
                <div id="stats-length-chart"></div>
                <div class="legend" id="stats-length-legend"></div>
            </div>
        </div>
    </div>
</body>
</html>
