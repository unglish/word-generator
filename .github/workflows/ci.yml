name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test
        run: npm test

  benchmark:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Perf regression gate
        run: npm run test:perf

      - name: Benchmark
        run: npx vitest bench --run

  quality:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Quality Benchmark
        env:
          QUALITY_TRIALS: '3'
          QUALITY_MAX_ITERATIONS: '120000'
          QUALITY_GATE_SAMPLE_SIZE: '120000'
          QUALITY_MODE_SAMPLE_SIZE: '30000'
        run: npx vitest run --config vitest.quality.config.ts --reporter=verbose

      - name: Post Quality Report
        if: success() || failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'quality-report.json';

            if (!fs.existsSync(path)) {
              console.log('No quality-report.json found, skipping comment.');
              return;
            }

            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const nf = new Intl.NumberFormat('en-US');
            const fmt = (n) => n !== null && n !== undefined ? nf.format(Number(n)) : 'not reached';

            // Common words table
            const trialsRan = (report.commonWords?.trials || 0) > 0;
            const milestones = report.commonWords?.milestones || {};
            let commonSection = '';
            if (trialsRan) {
              let commonTable = '| Milestone | Iterations |\n|-----------|------------|\n';
              for (const pct of [50, 75, 90, 100]) {
                const data = milestones[`${pct}%`];
                const val = data ? fmt(data.median) : 'N/A';
                commonTable += `| ${pct}% | ${val} |\n`;
              }
              commonSection = `### Common Words (median of ${report.commonWords.trials} trials, max ${fmt(report.commonWords.maxIterations)} iterations)\n${commonTable}\n`;
            }

            // Gates table
            const gates = report.gates || {};
            const gateChecks = [
              ['5+ consonant runs', gates.fiveConsecutiveConsonants, '= 0', gates.fiveConsecutiveConsonants === 0],
            ];
            const allGatesPass = gateChecks.every(g => g[3]);
            let gatesTable = `| Gate | Result | Threshold |\n|------|--------|-----------|\n`;
            for (const [name, val, threshold] of gateChecks) {
              gatesTable += `| ${name} | ${val} | ${threshold} |\n`;
            }

            // Metrics table
            const metrics = report.metrics || {};
            let metricsTable = '| Metric | Value |\n|--------|-------|\n';
            metricsTable += `| 4-cons clusters | ${fmt(metrics.fourConsonantClusters?.count)} (${metrics.fourConsonantClusters?.rate}%) |\n`;
            metricsTable += `| dk | ${fmt(metrics.dk)} |\n`;
            metricsTable += `| ckt | ${fmt(metrics.ckt)} |\n`;
            metricsTable += `| -owngs | ${fmt(metrics.owngs)} |\n`;
            metricsTable += `| -reng/-teng | ${fmt(metrics.rengTeng)} |\n`;
            metricsTable += `| Avg length | ${metrics.avgLength} |\n`;
            metricsTable += `| Unique rate | ${metrics.uniqueRate}% |\n`;

            const marker = '<!-- quality-report -->';
            const body = `${marker}\n## ðŸ¦‰ Quality Report\n\n${commonSection}### Quality Gates ${allGatesPass ? 'âœ…' : 'âŒ'}\n${gatesTable}\n### Quality Metrics\n${metricsTable}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
